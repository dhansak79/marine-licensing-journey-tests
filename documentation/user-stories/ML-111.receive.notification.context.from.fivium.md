# ML-111: Receive Notification Context from Fivium

## User Story

**AS** an applicant  
**I WANT** information from my journey through the interactive assistance tool to be available in my notification  
**SO THAT** I can see information about the journey and the terms of the exemption I am undertaking

## Background

The interactive assistance tool (IAT) provided by Fivium helps the user determine what type of thing they need to apply for, and routes the user to the correct 'application' journey. For exemptions, the IAT will route the user into the new service, and it will pass in contextual information about what the user had done within IAT. This will be used within the new service to customise the journey and ensure a seamless handover from the Fivium-owned part of the service (IAT) into the new service.

There are four pieces of data that will be retrieved from the Fivium URL -

**Activity type** - the top level activity that the user is conducting e.g. "Dredging"

**Activity subtype** - lower level of detail on the activity being performed e.g. "Navigational dredging"

**Article** - the article of the legislation under which the activity is exempt from needing a licence e.g. "Article 25"

**PDF Download URL** - the URL for the PDF prepared by Fivium, which shows all the user's answers from the IAT

## Resources

Explainer diagram in Mural

url to access uat IAT which has got the changes https://marinelicensingtest.marinemanagement.org.uk/mmofox5uat/journey/self-service/start

The steps to reach article 17 which has got the necessary changes with the button

Example URL - https://marine-licensing-frontend.test.cdp-int.defra.cloud/?ADV_TYPE=EXE&ARTICLE=17&outcomeType=WO_EXE_AVAILABLE_ARTICLE_17&pdfDownloadUrl=https://marinelicensingtest.marinemanagement.org.uk/mmofox5uat/journey/self-service/outcome-document/0233066a-a875-443e-890d-80c392d83ea2&ACTIVITY_TYPE=DEPOSIT&EXE_ACTIVITY_SUBTYPE_DEPOSIT=scientificResearch

## Screenshots

### IAT to Marine Licensing Handover Flow

Diagram showing the flow from the Fivium Interactive Assistance Tool (IAT) to the marine licensing service. The IAT captures user inputs about their activity and determines the appropriate exemption article, then generates a URL with query parameters containing activity type, activity subtype, article code, and PDF download URL. This URL launches the marine licensing service with the contextual information pre-populated.

### Example Query String Parameters

Screenshot showing a URL with query parameters in the browser address bar. The URL displays the four key parameters being passed from the IAT: ACTIVITY*TYPE (activity code such as DEPOSIT or DREDGE), EXE_ACTIVITY_SUBTYPE*[TYPE] (specific activity purpose like scientificResearch or navigationalDredging), ARTICLE (exemption article number like 17 or 21), and pdfDownloadUrl (link to the user's IAT answers document hosted on marinemanagement.org.uk).

## Acceptance Criteria

### AC1 - save activity type from IAT

**GIVEN** I have landed in the new service from IAT to start my exemption notification  
**WHEN** my notification record is created  
**THEN** the activity type (ACTIVITY_TYPE=<code>) from query string will be saved against my new notification  
**AND** it will have one of the following codes -

- CON
- DEPOSIT
- REMOVAL
- DREDGE
- INCINERATION
- EXPLOSIVES
- SCUTTLING

For example - ACTIVITY_TYPE=CON

### AC2 - save activity subtype from IAT

**GIVEN** I have landed in the new service from IAT to start my exemption notification  
**AND** my activity type is either CON, DEPOSIT, REMOVAL or DREDGE  
**WHEN** my notification record is created  
**THEN** the activity subtype from query string will be saved against my new notification  
**AND** the activity subtype will be provided in one of the following query string parameters (depending on the activity type from the previous AC) -

- EXE_ACTIVITY_SUBTYPE_CONSTRUCTION=<code>
- EXE_ACTIVITY_SUBTYPE_DEPOSIT=<code>
- EXE_ACTIVITY_SUBTYPE_REMOVAL=<code>
- EXE_ACTIVITY_SUBTYPE_DREDGING=<code>

**AND** the activity subtype will have one of the following codes -

- coastalProtectionDrainageOrFloodDefence
- crossrailAct
- deepseaMining
- defenceMiningCrossrail
- dredgedMaterial
- emergency
- fishing
- hullCleaning
- maintenance
- markersMooringsAidsToNavigation
- markersMooringsAndAidToNavigation
- miscellaneous
- navigationalDredging
- ObstructionsDanger
- pollutionResponse
- pontoons
- scientificResearch
- shellfish
- waste

For example -

- EXE_ACTIVITY_SUBTYPE_CONSTRUCTION=new
- EXE_ACTIVITY_SUBTYPE_DEPOSIT=dredgedMaterial
- EXE_ACTIVITY_SUBTYPE_REMOVAL=fishing
- EXE_ACTIVITY_SUBTYPE_DREDGING=navigationalDredging

**NOTE** - if the activity type is anything other than CON, DEPOSIT, REMOVAL or DREDGE then the activity subtype will not be present

### AC3 - save article from IAT

**GIVEN** I have landed in the new service from IAT to start my exemption notification  
**WHEN** my notification record is created  
**THEN** the article (ARTICLE=<code>) from query string will be saved against my new notification  
**AND** it will have one of the following codes -

- 13
- 17
- 17A
- 17B
- 18A
- 20
- 21
- 25
- 25A
- 26A
- 34
- 35

For example - ARTICLE=21

### AC4 - save PDF download URL from IAT

**GIVEN** I have landed in the new service from IAT to start my exemption notification  
**WHEN** my notification record is created (i.e. when the project name is saved to the database)  
**THEN** the pdf download URL (pdfDownloadUrl=<url>) from query string will also be saved against my new notification

For example - pdfDownloadUrl=https://marinelicensingtest.marinemanagement.org.uk/mmofox5uat/self-service/outcome-document/87d2ec22-0fb0-4968-8860-5773a257c244

---

## Implementation Status

### ✅ Completed Implementation

- **Query parameter validation** - Full Joi schema validation for all IAT context parameters
- **Activity type capture** - All seven activity types (CON, DEPOSIT, REMOVAL, DREDGE, INCINERATION, EXPLOSIVES, SCUTTLING) supported
- **Activity subtype capture** - Conditional validation and storage based on activity type
- **Article code capture** - All thirteen article codes validated and stored
- **PDF download URL capture** - URL pattern validation and secure storage
- **Session caching** - IAT context cached in session for journey persistence
- **Complete test automation** - Comprehensive feature file with IAT context validation

### Technical Implementation Details

1. **Constants Definition**: `mcms-context.js` defines all valid activity types, subtypes, and article codes
2. **Validation Schema**: `schema.js` uses Joi for robust query parameter validation with conditional logic
3. **Session Management**: `cache-mcms-context.js` handles caching IAT context in user session
4. **Database Storage**: Context persisted when project name is saved to database
5. **URL Construction Helper**: `iat-url-builder.js` provides test infrastructure for IAT URL generation

### Test Coverage

**✅ Launch Fivium IAT Scenarios (covered by launch.fivium.iat.feature)**:

1. **Launch application with valid IAT query parameters** - All four parameters validated and stored
2. **Activity subtype conditional validation** - Subtype required for CON, DEPOSIT, REMOVAL, DREDGE only
3. **PDF URL pattern validation** - Secure marinemanagement.org.uk domain validation
4. **Query parameter integration** - All test scenarios now use IAT context throughout user journeys

### Integration Points

- **Project Name (ML-1)**: IAT context saved when notification created with project name
- **Check Your Answers (ML-142)**: IAT context displayed in project summary card
- **Submit Notification (ML-84)**: IAT context submitted to D365 with notification
- **All Test Scenarios**: Universal IAT context integration across complete test suite

**Priority:** Complete - Full IAT integration implemented with robust validation, session management, and comprehensive test coverage across all user journeys.
