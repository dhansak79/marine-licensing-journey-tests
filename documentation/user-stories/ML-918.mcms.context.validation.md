# ML-918: MCMS Context Validation

## User Story

**AS** a developer  
**I WANT** to improve MCMS context validation and error handling  
**SO THAT** we can diagnose issues with IAT query strings whilst ensuring the system remains functional

## Background

When the marine licensing service receives MCMS context via IAT query strings, validation failures can cause issues with tracking and debugging. This story ensures that even when validation fails, the full context is preserved for debugging purposes, whilst ensuring invalid data doesn't contaminate valid data storage locations.

## Resources

TBC

## Out of Scope

N/A

## Questions and Answers

N/A

## Technical Requirements

### Frontend

If the IAT querystring fails validation in the front end, we should log the error but store the full query string in the request cache anyway, then when the project name form is submitted it should be sent to the backend.

When retrieving the MCMS context from request yar cache, if there's nothing in cache, change the log message to No MCMS context cached for URL:

Don't validate activity subtype query string params (eg EXE_ACTIVITY_SUBTYPE_DEPOSIT) as they're not used anyway.

### Backend

On the backend if the MCMS context that is sent with the 'new project name' form payload, fails validation then log out the problem, and the whole MCMS query string should be saved in the mongo DB record under the mcmsContext object (eg iatQueryString).

Don't validate activity subtype query string params (eg EXE_ACTIVITY_SUBTYPE_DEPOSIT) as they're not used anyway.

### Daniel's ask

Make sure that incorrect values are not stored in the same place as correct ones as this will cause CYA issues.

It would be useful to set a variable hidden on the front end to say whether MCMS context was valid or not for the purposes of testing (I can assert against this).

When running journey tests with docker locally, use a domain mapping

127.0.0.1 marine-licensing-frontend.local

nano /etc/hosts

## Acceptance Criteria

### Frontend

**AC1 - Failed validation handling**

**GIVEN** the IAT querystring fails validation in the frontend  
**WHEN** validation occurs  
**THEN** the error is logged  
**AND** the full query string is stored in the request cache  
**AND** when the project name form is submitted, the query string is sent to the backend

**AC2 - Missing cache log message**

**GIVEN** MCMS context is being retrieved from request yar cache  
**WHEN** there is nothing in cache  
**THEN** the log message displays "No MCMS context cached for URL:"

**AC3 - Activity subtype parameters**

**GIVEN** IAT querystring contains activity subtype query string params (eg EXE_ACTIVITY_SUBTYPE_DEPOSIT)  
**WHEN** validation occurs  
**THEN** these parameters are not validated as they're not used

**AC4 - Testing variable**

**GIVEN** MCMS context validation has occurred  
**WHEN** the page loads  
**THEN** a hidden variable is set on the frontend indicating whether MCMS context was valid or not  
**AND** this variable can be asserted against in tests

### Backend

**AC5 - Failed validation handling**

**GIVEN** MCMS context is sent with the 'new project name' form payload  
**AND** the MCMS context fails validation  
**WHEN** validation occurs  
**THEN** the problem is logged out  
**AND** the whole MCMS query string is saved in the MongoDB record under the mcmsContext object (eg iatQueryString)

**AC6 - Data separation**

**GIVEN** MCMS context validation has failed  
**WHEN** data is stored in MongoDB  
**THEN** incorrect values are NOT stored in the same place as correct ones  
**AND** this prevents CYA issues

**AC7 - Activity subtype parameters**

**GIVEN** MCMS context contains activity subtype query string params (eg EXE_ACTIVITY_SUBTYPE_DEPOSIT)  
**WHEN** validation occurs  
**THEN** these parameters are not validated as they're not used

**AC8 - Project summary card display with invalid context**

**GIVEN** MCMS context validation has failed or is missing  
**WHEN** the check your answers page is displayed  
**THEN** the project summary card is displayed  
**AND** only the project name field is shown  
**AND** the IAT-specific fields (activity type, activity purpose, exemption reason, PDF download) are not displayed

### Testing

**AC9 - Local testing domain mapping**

**GIVEN** journey tests are running with docker locally  
**WHEN** tests need to access the frontend  
**THEN** the domain mapping `127.0.0.1 marine-licensing-frontend.local` is used  
**AND** this can be configured in `/etc/hosts`

## Standard Behaviour

**Logging** - all validation failures and errors should be logged with sufficient detail for debugging purposes.

**Data integrity** - valid and invalid data must be stored separately to prevent contamination of the check your answers functionality.
