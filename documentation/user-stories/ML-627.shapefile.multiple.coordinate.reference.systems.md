# ML-627: Shapefile File Upload - Add Support for Multiple Coordinate Reference Systems

## User Story

**AS** an applicant  
**I WANT** to upload Shapefile coordinate files in various coordinate reference systems  
**SO THAT** my site coordinates are correctly processed regardless of the coordinate system used in my source files

## Background

We are using [Shapefile](https://www.npmjs.com/package/shapefile) as our library to read and parse coordinates from Shapefile zips. We are extracting to geoJSON [RFC 7946](https://datatracker.ietf.org/doc/html/rfc7946).

GeoJSON specifies that all coordinates are in WGS84.

The issue is that the parsing library is not converting other coordinate systems into valid geoJSON.

This is caveated in the README:

> This library does not support parsing coordinate reference system specifications (.prj); see Proj4js for parsing well-known text (WKT) specifications.

We might want to:

- investigate the Shapefile format to determine all possible coordinate systems that may be allowed in our source files
- determine a tactical fix (if any)
- determine a strategic fix

E.g. either we do the conversion into WGS84 ourselves, perhaps using an additional package, or we see if there is a better parsing library that produces valid and conformant geoJSON.

This problem does not apply to KML files, as I believe they use WGS84 internally.

## Resources

- [Shapefile npm package](https://www.npmjs.com/package/shapefile)
- [GeoJSON RFC 7946](https://datatracker.ietf.org/doc/html/rfc7946)
- [Proj4js - coordinate transformation library](https://github.com/proj4js/proj4js)
- [Well-known text (WKT) coordinate reference system specifications](https://en.wikipedia.org/wiki/Well-known_text_representation_of_coordinate_reference_systems)
- Shapefile .prj file format documentation
- OSGB36 (British National Grid) coordinate system documentation
- EPSG coordinate reference system database

## Out of Scope

- KML file coordinate system handling (already uses WGS84)
- Frontend coordinate system selection by users
- Manual coordinate entry validation
- Historical coordinate reference system support beyond commonly used systems

## Questions and Answers

**Q.** What coordinate reference systems are commonly used in Shapefiles submitted to MMO?

**A.** TBC - requires investigation of existing MCMS data and consultation with MMO stakeholders.

**Q.** Should we support all possible coordinate reference systems or focus on the most common ones?

**A.** TBC - will be determined as part of the investigation phase.

**Q.** What should happen when a Shapefile uses an unsupported coordinate reference system?

**A.** TBC - options include: display clear error message, attempt best-effort conversion, or reject the file with guidance.

**Q.** Can we use Proj4js to handle the coordinate transformations?

**A.** TBC - requires technical investigation to assess compatibility, performance, and accuracy.

**Q.** Should we validate the coordinate reference system before or during file processing?

**A.** TBC - needs to balance user experience (early validation) with technical efficiency.

## Technical Investigation

### Current State

- **Shapefile parsing**: Uses shapefile npm package
- **Output format**: GeoJSON (RFC 7946)
- **GeoJSON requirement**: All coordinates must be in WGS84
- **Current limitation**: Parser does not convert from other coordinate systems
- **Missing capability**: No .prj file parsing (coordinate reference system specification)

### Investigation Areas

1. **Shapefile Format Analysis**
   - Identify all coordinate reference systems used in .prj files
   - Analyse common coordinate systems in UK marine licensing context
   - Determine frequency of non-WGS84 coordinate systems in user submissions

2. **Tactical Solution Options**
   - Implement Proj4js integration for coordinate transformation
   - Add .prj file parsing capability
   - Validate coordinate reference system before processing
   - Provide clear error messages for unsupported systems

3. **Strategic Solution Options**
   - Evaluate alternative Shapefile parsing libraries with built-in CRS support
   - Implement comprehensive coordinate transformation pipeline
   - Create extensible system for adding new coordinate reference systems
   - Consider caching transformation definitions for performance

### Proposed Approach

**Phase 1: Investigation**

- Analyse existing MCMS Shapefile submissions to identify used coordinate systems
- Research Shapefile .prj file format and common coordinate reference systems
- Evaluate Proj4js capabilities and limitations

**Phase 2: Tactical Implementation**

- Implement .prj file parsing
- Integrate Proj4js for coordinate transformation to WGS84
- Add validation for supported coordinate reference systems
- Implement error handling for unsupported systems

**Phase 3: Testing & Validation**

- Test with real-world Shapefiles in various coordinate systems
- Verify accuracy of coordinate transformations
- Ensure GeoJSON output conforms to RFC 7946
- Validate integration with existing file upload workflow

## Screenshots

### Diagram 1: Current Shapefile Processing Flow

```
User uploads Shapefile (.zip)
         ‚Üì
Extract Shapefile components (.shp, .shx, .dbf, .prj)
         ‚Üì
Parse using shapefile library
         ‚Üì
‚ùå ISSUE: Coordinates not in WGS84 if .prj specifies different CRS
         ‚Üì
Output GeoJSON (non-conformant if not WGS84)
         ‚Üì
‚ùå Invalid GeoJSON for coordinates in other systems
```

### Diagram 2: Proposed Enhanced Processing Flow

```
User uploads Shapefile (.zip)
         ‚Üì
Extract Shapefile components (.shp, .shx, .dbf, .prj)
         ‚Üì
Parse .prj file to identify coordinate reference system
         ‚Üì
Parse shapefile using shapefile library
         ‚Üì
‚úÖ NEW: Transform coordinates to WGS84 using Proj4js
         ‚Üì
Output valid GeoJSON (RFC 7946 conformant)
         ‚Üì
‚úÖ All coordinates in WGS84 as required
```

### Diagram 3: Error Handling for Unsupported CRS

```
User uploads Shapefile with unsupported CRS
         ‚Üì
Parse .prj file
         ‚Üì
Identify coordinate reference system
         ‚Üì
Check against supported CRS list
         ‚Üì
‚ùå CRS not supported
         ‚Üì
Display clear error message:
"The coordinate system in your Shapefile is not supported.
 Supported systems: WGS84, OSGB36 (British National Grid)
 Please convert your file or contact support."
```

## Acceptance Criteria

### AC1 - Investigate coordinate reference systems

**GIVEN** we need to support Shapefile uploads with various coordinate systems  
**WHEN** the investigation is conducted  
**THEN** we will have documented:

- All coordinate reference systems found in historical MMO submissions
- Frequency and priority of each coordinate reference system
- Technical feasibility of supporting each system
- Recommended list of coordinate systems to support

### AC2 - Implement .prj file parsing

**GIVEN** a Shapefile contains a .prj file with coordinate reference system specification  
**WHEN** the file is uploaded and processed  
**THEN** the system will:

- Successfully extract and parse the .prj file
- Identify the coordinate reference system specified
- Log the identified coordinate system for debugging purposes

### AC3 - Implement coordinate transformation to WGS84

**GIVEN** a Shapefile contains coordinates in a supported non-WGS84 coordinate system  
**WHEN** the file is processed  
**THEN** the system will:

- Transform all coordinates from the source coordinate system to WGS84
- Output valid GeoJSON conforming to RFC 7946
- Preserve coordinate accuracy within acceptable tolerances
- Maintain all other Shapefile data (attributes, geometry types)

### AC4 - Handle unsupported coordinate reference systems

**GIVEN** a Shapefile contains coordinates in an unsupported coordinate system  
**WHEN** the file is uploaded  
**THEN** the system will:

- Detect the unsupported coordinate reference system
- Display a clear error message to the user
- Provide guidance on supported coordinate systems
- Prevent invalid data from being saved

### AC5 - Support OSGB36 (British National Grid)

**GIVEN** OSGB36 is commonly used for UK marine licensing  
**WHEN** a Shapefile with OSGB36 coordinates is uploaded  
**THEN** the system will:

- Successfully parse the coordinate reference system
- Transform coordinates from OSGB36 to WGS84
- Output valid GeoJSON with accurate coordinate conversion
- Display the site(s) correctly on the map

### AC6 - Maintain backward compatibility

**GIVEN** existing Shapefiles in WGS84 coordinate system  
**WHEN** these files are uploaded after the changes  
**THEN** the system will:

- Continue to process WGS84 Shapefiles without transformation
- Maintain existing functionality and accuracy
- Ensure no regression in file processing performance

## Standard Behaviour

**Error handling** - coordinate transformation errors will be logged appropriately for debugging and will provide user-friendly error messages indicating the issue and possible solutions.

**Performance** - coordinate transformation should not significantly impact file upload processing time. Large Shapefiles with many features should be processed efficiently.

**Accuracy** - coordinate transformations must maintain positional accuracy appropriate for marine licensing purposes, with acceptable tolerance levels documented and tested.

**Logging** - all coordinate system identifications and transformations will be logged for audit purposes, including source CRS, target CRS, and transformation success/failure.

**Validation** - transformed coordinates will be validated to ensure they fall within expected bounds (e.g., UK territorial waters for marine licensing).

**Configuration** - supported coordinate reference systems will be configurable, allowing new systems to be added without code changes where possible.

**Documentation** - technical documentation will be maintained for supported coordinate systems, transformation parameters, and troubleshooting guidance.

---

## Implementation Status

### üìã Planned Implementation

This story represents investigation and implementation work to support multiple coordinate reference systems in Shapefile uploads.

**Priority:** High - Blocks users who have Shapefiles in non-WGS84 coordinate systems from successfully uploading their site coordinates.

**Dependencies:**

- Shapefile upload functionality (ML-70)
- GeoJSON validation in backend
- File upload error handling

**Technical Dependencies:**

- Proj4js library evaluation and integration
- .prj file parsing implementation
- Coordinate transformation testing framework
