# ML-140: File Upload Check Your Answers

## User Story

**AS** an applicant  
**I WANT** to see the answers I have provided  
**SO THAT** I can check everything is correct before I submit my notification

## Background

Once the user has completed all the tasks on the task list, they will be able to access the "Check your answers" page, which will play back all their answers and allow them to verify that the answers are OK, ready for submission of their notification.

This story builds upon https://eaflood.atlassian.net/browse/ML-82, which defines the behaviour of the "Check your answers" page for a circular site, extending the behaviour to cater for the display of an uploaded site (where the user has uploaded their site details in a KML/Shapefile). As such, this story is only focussed on the "Site details" card, and the remaining behaviour of the page (including any out of scope items listed in ML-82) remains unchanged.

It is worth noting that the "Site details" summary card being displayed here is the same as implemented in https://eaflood.atlassian.net/browse/ML-74, and code re-use may be beneficial.

## Resources

- Link to "Check your answers" page in prototype MVP - upload site version
- Link to data dictionary

## Out of Scope

This story does not include the "Map view" part of the "Site details" summary card; the rendering of the site coordinates onto a map will be delivered under a separate ticket

This story does not cover the ability to make changes to site information (via the "Change" link)

This story does not cover behaviour on the "Check your answers" page outside of the "Site details" card

This story does not cover the survey and other links in the header

This story does not cover the links in the footer

## Questions and Answers

TBC

## Screenshots

### Screenshot 1: Check Your Answers Page - KML File Upload

**Page layout showing:**

- Standard GOV.UK header with "Get permission for a marine activity" service name
- Beta banner with feedback link
- Back link for navigation
- "Hammersmith pontoon construction" displayed as page caption above the main heading
- "Check your answers before sending your information" as the main H1 heading
- Multiple summary cards displaying completed task information:
  - **Project details** card with project name
  - **Activity dates** card with start and end dates
  - **Activity details** card with activity description and related information
  - **Site details** card (focus of this story) containing:
    - **Method of providing site location**: "Upload a file with the coordinates of the site"
    - **File type**: "KML"
    - **File uploaded**: "coordinates.kml" (example filename)
    - **Map view**: [Not implemented in this story - placeholder row]
  - **Public register** card with information withholding preferences
- "Now send your information" section with confirmation text
- "Confirm and send" button (green) positioned below all summary cards
- Standard GOV.UK footer with licensing and regulatory information

### Screenshot 2: Check Your Answers Page - Shapefile Upload

**Page layout showing:**

- Same overall layout as Screenshot 1
- Site details summary card with Shapefile-specific content:
  - **Method of providing site location**: "Upload a file with the coordinates of the site"
  - **File type**: "Shapefile"
  - **File uploaded**: "Hammersmith_coordinates.zip" (example Shapefile name with zip extension)
  - **Map view**: [Not implemented in this story - placeholder row]
- All other cards and navigation elements remain consistent with Screenshot 1

**Note**: Change links shown in the prototype are not included in this implementation phase

## Acceptance Criteria

### AC1 - "Site details" card for uploaded site

**GIVEN** I am viewing the "Check your answers" page  
**AND** I have provided details of an uploaded site  
**WHEN** I view the content of the "Site details" summary card  
**THEN** I see the following information:

- **Method of providing site location** - populated with fixed text: "Upload a file with the coordinates of the site"
- **File type** - populated with either "KML" or "Shapefile", depending on what was uploaded
- **File uploaded** - populated with the name of the uploaded file, including the file extension e.g. "Hammersmith_coordinates.kml"
- **Map view** - the "Map view" row shown in the prototype will not be delivered as part of this story, it will be delivered as a separate ticket, subject to a spike for the map rendering

**NOTE** - this is the same summary card that has been implemented as part of https://eaflood.atlassian.net/browse/ML-74

**NOTE** - the "Change" link shown in the prototype will not be delivered as part of this story, they will be delivered as a separate ticket

## Standard Behaviour

**"Back" link** - when I select the "Back" link (if present), I will be returned to the page I was on immediately prior to the current page. Any changes I made on the current page will be discarded.

**"Cancel" link** - when I select the "Cancel" link (if present) I will be returned to the task list. Any changes I made on the current page will be discarded.

**Displaying validation errors** - if any validation errors are triggered, they will be displayed in standard GDS format i.e. [error summary](https://design-system.service.gov.uk/components/error-summary/) at the top of the page, and [error message](https://design-system.service.gov.uk/components/error-message/) against the specific item that triggered the error. The wording of error messages should be verified against the data dictionary.

---

## Implementation Status

### ✅ Completed Implementation

- **Frontend integration tests** - Comprehensive DOM-level testing of file upload site details display on check your answers page
- **Backend validation fix** - GeoJSON schema updated to support optional `id` properties on features (KML/Shapefile compatibility)
- **Journey test scenarios** - High-level Gherkin scenarios for KML and Shapefile upload validation
- **File upload display functionality** - Complete site details summary card rendering for uploaded files
- **Test automation coverage** - Multi-layered test strategy with integration and journey test coordination

### Implementation Details

#### **Frontend Integration Tests** ([marine-licensing-frontend/tests](https://github.com/DEFRA/marine-licensing-frontend/tree/main/tests))

**Primary Test Coverage:**

- **Data-driven validation** - Single parameterised test covering KML and Shapefile scenarios
- **Comprehensive DOM validation** - Validates every element and text content on the check your answers page:
  - Page structure (title, back link, heading, caption)
  - All summary cards presence and content
  - Site details card specific to file uploads (method, file type, filename)
  - Project details, activity dates, activity details, public register sections
  - Submission section with confirm button

**Test Architecture:**

- **Helper functions** following Uncle Bob's Clean Code principles for readable, expressive tests
- **Fixtures-based** test data with comprehensive `expectedPageContent` objects
- **Mock strategy** for session cache and API calls ensuring test isolation
- **DOM Testing Library** integration for semantic, accessible element queries

**Files:**

- `file-upload-site-details.test.js` - Main test suite with data-driven approach
- `fixtures.js` - Test data scenarios for KML and Shapefile uploads

#### **Journey Tests** (this repository)

**Scenario Coverage:**

- **KML file upload** end-to-end validation through complete user journey
- **Shapefile upload** end-to-end validation through complete user journey
- **Check your answers validation** - File upload specific validation integrated into existing then steps

**Files:**

- `test/features/check.your.answers.feature` - High-level Gherkin scenarios
- `test/steps/check.your.answers.steps.js` - Extended step definitions for file upload validation
- `test-infrastructure/screenplay/` - Enhanced interactions and page objects for file upload support

#### **Backend Validation Enhancement**

**Problem Resolved:**

- **KML parsing compatibility** - Backend GeoJSON schema updated to allow optional `id` properties per RFC 7946
- **Comprehensive test coverage** - 5 new backend validation tests covering all `id` property scenarios

**Implementation:**

- Updated GeoJSON validation schema in backend repository
- Enhanced test coverage for all `id` property scenarios

### Test Strategy Benefits

#### **Complementary Test Architecture**

**Integration Tests (Frontend):**

- ✅ **Detailed validation** - Every DOM element, text content, and structural requirement tested
- ✅ **Fast execution** - Isolated component testing without full application stack
- ✅ **Comprehensive coverage** - All AC1 requirements validated with precision
- ✅ **Developer feedback** - Immediate feedback on template changes and data flow

**Journey Tests (E2E):**

- ✅ **User workflow validation** - Complete file upload journey from start to finish
- ✅ **Cross-component integration** - Validates data flow between frontend/backend/cache
- ✅ **Business scenario coverage** - Real user scenarios with actual file uploads

**Coverage Optimization:**

- **Reduced journey test complexity** - High-level scenarios focus on user workflow, not detailed validation
- **Enhanced development velocity** - Developers get immediate feedback from fast integration tests
- **Comprehensive validation** - Combined approach ensures both detailed validation and end-to-end functionality

#### **Quality Assurance**

**Code Quality:**

- **Uncle Bob's Clean Code principles** applied to test structure with descriptive helper functions
- **Data-driven approach** eliminates code duplication across test scenarios
- **Maintainable test architecture** with clear separation of concerns

**Test Reliability:**

- **Mock strategy** for external dependencies ensuring consistent test execution
- **Comprehensive fixture data** providing predictable test scenarios
- **Backend validation robustness** with GeoJSON standard compliance

**Priority:** Complete - Full ML-140 functionality implemented with comprehensive multi-layered test coverage combining detailed integration tests with high-level journey validation.
